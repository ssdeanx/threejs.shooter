# Blender Workflow

This document consolidates Blender-related guidance for asset preparation and integration with the Three.js/R3F shooter project.

## Goals

- Maintain consistent model and texture pipelines.
- Ensure exported assets are performant and compatible with our runtime (Three.js + R3F).
- Keep repository hygiene: correct directories, naming, and formats.

---

MCP Tools — Blender Pipeline (3D Assets, Textures, Materials)

[*] Purpose
Define and enforce a standardized MCP-based content pipeline using the connected Blender MCP server and related asset sources. This section is a planning/spec reference; do not implement new tools without a prior planning step logged here.

BP-1 Tools Inventory (exact names and params as implemented)

- blender.get_scene_info() — Get detailed information about the current Blender scene.
  Parameters: none.

- blender.get_object_info(object_name) — Get detailed information about a specific object in the Blender scene.
  Parameters:
  - object_name: string (required)

- blender.get_viewport_screenshot(max_size) — Capture a screenshot of the current Blender 3D viewport.
  Parameters:
  - max_size: integer (optional; default 800). Returns an Image.

- blender.execute_blender_code(code) — Execute arbitrary Python code in Blender (use step-by-step micro-scripts).
  Parameters:
  - code: string (required)

- blender.get_polyhaven_categories(asset_type) — Get a list of categories for a specific asset type on Polyhaven.
  Parameters:
  - asset_type: string (hdris | textures | models | all)

- blender.search_polyhaven_assets(asset_type, categories) — Search for assets on Polyhaven with optional filtering.
  Parameters:
  - asset_type: string (hdris | textures | models | all)
  - categories: string (optional; comma-separated)

- blender.download_polyhaven_asset(asset_id, asset_type, resolution, file_format) — Download and import a Polyhaven asset into Blender.
  Parameters:
  - asset_id: string (required)
  - asset_type: string (required; hdris | textures | models)
  - resolution: string (optional; e.g., 1k, 2k, 4k)
  - file_format: string (optional; hdr/exr for HDRIs; jpg/png for textures; gltf/fbx for models)

- blender.set_texture(object_name, texture_id) — Apply a previously downloaded Polyhaven texture to an object.
  Parameters:
  - object_name: string (required)
  - texture_id: string (required)

- blender.get_polyhaven_status() — Check if PolyHaven integration is enabled in Blender.
  Parameters: none.

- blender.get_hyper3d_status() — Check if Hyper3D Rodin integration is enabled in Blender.
  Parameters: none. Note: silently remember the key type.

- blender.get_sketchfab_status() — Check if Sketchfab features are available.
  Parameters: none.

- blender.search_sketchfab_models(query, categories, count, downloadable) — Search for models on Sketchfab.
  Parameters:
  - query: string (required)
  - categories: string (optional; comma-separated)
  - count: integer (optional; default 20)
  - downloadable: boolean (optional; default true)

- blender.download_sketchfab_model(uid) — Download and import a Sketchfab model by its UID.
  Parameters:
  - uid: string (required)

- blender.generate_hyper3d_model_via_text(text_prompt, bbox_condition) — Generate a 3D asset via Hyper3D (text).
  Parameters:
  - text_prompt: string (required; English)
  - bbox_condition: array of floats length 3 (optional; [Length, Width, Height] ratio)

- blender.generate_hyper3d_model_via_images(input_image_paths, input_image_urls, bbox_condition) — Generate a 3D asset via images.
  Parameters:
  - input_image_paths: array of absolute paths (optional; required in MAIN_SITE mode)
  - input_image_urls: array of URLs (optional; required in FAL_AI mode)
  - bbox_condition: array of numbers length 3 (optional)
  Only one of input_image_paths or input_image_urls must be provided based on current mode.

- blender.poll_rodin_job_status(subscription_key, request_id) — Poll Hyper3D job completion.
  Parameters:
  - subscription_key: string (MAIN_SITE mode)
  - request_id: string (FAL_AI mode)
  Behavior:
  - MAIN_SITE: returns list of statuses; done when all are "Done"; "Failed" indicates failure.
  - FAL_AI: returns task status; done when "COMPLETED"; "IN_PROGRESS" indicates running.

- blender.import_generated_asset(name, task_uuid, request_id) — Import the asset generated by Hyper3D.
  Parameters:
  - name: string (required; scene object name)
  - task_uuid: string (MAIN_SITE mode; optional)
  - request_id: string (FAL_AI mode; optional)
  Supply exactly one of task_uuid or request_id based on the current Hyper3D mode.

BP-2 Content Pipeline (High Level)

1) Concept → Proxy
   - Use simple proxies (boxes/capsules) sized for gameplay first; author colliders in ECS.
   - Artifacts: viewport screenshot, notes.
2) Source Acquisition
   - Use PolyHaven for HDRIs/textures/models and Sketchfab for downloadable models.
   - Prefer CC0 content; record license metadata alongside assets.
3) Hyper3D Generation (when custom)
   - For unique props/weapons/characters, generate via Hyper3D text prompt; specify bbox_condition for normalized dimensions.
   - Poll status and import once complete; rescale as needed.
4) Material/UV Pass
   - Verify UVs with blender.get_object_info(); re-unwrap if needed; apply PBR textures.
5) Optimization
   - Apply decimate/LOD; triangulate if necessary; ensure consistent normals; pack textures.
6) Export → Game
   - Export GLB/GLTF with embedded textures; maintain Y-up, meters units; pivot at base.
   - Maintain a manifest.json per asset with: units, scale, LODs, collider hint, license, source.

BP-3 Automation Patterns

- Execute blender.execute_blender_code() in small, reviewable chunks; log each chunk and the outcome.
- Store downloaded assets and generated models in versioned folders: assets/{models,textures,hdris}/source|processed.
- After import/generation, call blender.get_object_info() and snapshot materials/UVs into the manifest.
- For textures, prefer 1k by default; allow 2k or 4k for hero assets; ensure power-of-two dimensions.

Policy & Hygiene (Content)

- [HY] No orphan assets: every asset must have a manifest and be referenced by the game or a pending task with owner/date.
- [HY] License metadata must be captured (SPDX or URL) before merging assets.
- [BP] Consistent pivots/origin at base; scale applied (1,1,1); transforms baked before export.
- [BP] Texture naming: {asset}_{map}_{res}.png (e.g., crate_albedo_2k.png).
- [*] All Blender/asset operations must be planned with a short note (who/what/why) in the Session Log.

MCP Tools — Auxiliary (Web, NPM, Codacy)

- fetch.fetch(url) — Internet retrieval for docs/specs (e.g., Rapier/Three/GLTF).
- tavily.tavily-search — Real-time search for references/news (when needed).
- npm-sentinel — Check NPM versions/vulns/size before adding deps (avoid bloat).
- codacy_cli_analyze — On-demand local quality pass (do not replace PR gates).
- context7 — Live docs for libraries (routing/hooks specifics when integrating R3F).

Blender MCP Usage Playbooks (Examples)

- Texture an imported model:
  1) blender.search_polyhaven_assets(asset_type="textures", categories="avatar") → pick texture_id
  2) blender.download_polyhaven_asset(asset_id=..., asset_type="textures", resolution="1k")
  3) blender.set_texture(object_name="Crate_A", texture_id=...)
  4) blender.get_viewport_screenshot() → attach to PR
- Generate a hero prop via Hyper3D:
  1) blender.generate_hyper3d_model_via_text("sci‑fi crate with beveled edges, PBR-ready", bbox_condition=[1.0,1.0,1.0])
  2) blender.poll_rodin_job_status(...) until Done/COMPLETED
  3) blender.import_generated_asset(name="Crate_Hero", task_uuid|request_id)
  4) blender.get_object_info("Crate_Hero") → verify materials/UVs; create manifest

Future Tracks (Art)

- [ ] Establish asset folder structure and manifest schema.
- [ ] Add automated preview renders via blender.get_viewport_screenshot() for PR checks.
- [ ] Define LOD budgets and per-platform texture caps (desktop/mobile).
- [ ] Author “collision hint” convention in manifest for ECS collider generation (cuboid/capsule/convex hull).

## Source of Truth

- Models (GLB preferred) live under `assets/models/...`
- Textures live under `assets/textures/...`

See the repository structure policies:

- Models: ['assets/models/characters/'](assets/models/characters:1), ['assets/models/weapons/'](assets/models/weapons:1), ['assets/models/targets/'](assets/models/targets:1)
- Textures: ['assets/textures/camo/'](assets/textures/camo:1), ['assets/textures/soldier/trimsheet/'](assets/textures/soldier/trimsheet:1), ['assets/textures/targets/'](assets/textures/targets:1)

## Blender → GLB Export Settings

Recommended baseline for GLB exports from Blender:

- Apply transforms before export (Object mode: Apply Location/Rotation/Scale).
- Triangulate meshes if needed for consistency.
- Ensure unit scale (meters) and reasonable object scales (avoid extreme magnitudes).
- Export materials compatible with glTF PBR (Base Color, Metallic-Roughness, Normal, Emissive, AO).
- Pack textures OR prefer relative external texture references that will be bundled under `assets/textures/...`.
- Remove unused materials, nodes, and animation tracks.

Export hints:

- File → Export → glTF 2.0 (.glb)
  - Format: GLB (Binary)
  - Include: Selected Objects (recommended) or Scene
  - Transform: +Y Up (default), Apply Modifiers: ON
  - Geometry: Compression optional (Draco OFF unless tested), UVs ON, Normals ON, Tangents (if using normal maps), Vertex Colors if needed
  - Materials: Export
  - Animations: Include if rigged/animated; bake actions
  - Extras: Exclude cameras/lights unless intentionally needed (we add runtime lights)

## Naming & Organization

Follow the repository conventions:

- Characters → ['assets/models/characters/'](assets/models/characters:1)
  - Examples: ['soldier.glb'](assets/models/characters/soldier.glb:1), ['hyper3d_soldier_character.glb'](assets/models/characters/hyper3d_soldier_character.glb:1)
- Weapons → ['assets/models/weapons/'](assets/models/weapons:1)
  - Examples: ['m4a1.glb'](assets/models/weapons/m4a1.glb:1), ['ak74.glb'](assets/models/weapons/ak74.glb:1)
- Targets/Environment → ['assets/models/targets/'](assets/models/targets:1)
  - Examples: ['crate.glb'](assets/models/targets/crate.glb:1), ['targets_all.glb'](assets/models/targets/targets_all.glb:1)

Textures:

- Soldier trimsheets under ['assets/textures/soldier/trimsheet/'](assets/textures/soldier/trimsheet:1)
- Camo atlases under ['assets/textures/camo/'](assets/textures/camo:1)
- Target textures under ['assets/textures/targets/'](assets/textures/targets:1)

File naming:

- Use clear, descriptive names indicating family and variant (e.g., `TargetSteel_01.glb`, `Tree_03_LOD1.glb`).
- Prefer power-of-two textures (512, 1024, 2048). Trimsheets commonly use 2K.

## Materials and Trimsheets

- Prefer trimsheets for repeated asset families to reduce draw calls and memory.
- Keep texture sets minimal: BaseColor, Normal, ORM (Occlusion-Roughness-Metallic), Emissive as needed.
- For character fabrics/gear, align with trimsheets in ['assets/textures/soldier/trimsheet/'](assets/textures/soldier/trimsheet:1).

## Rigs and Animation

- For rigged characters, ensure a clean, single Armature with consistent bone naming.
- Bake actions on export; verify that animation clips appear in the glTF.
- Keep socket/attachment empties (e.g., for weapon attachment) if required by runtime.

## Runtime Integration (Three.js/R3F)

- Import GLBs via Suspense-friendly hooks in React (R3F):
  - Hook: ['useGlbAsset()'](src/react/hooks/useGlbAsset.ts:1)
  - Preload: ['preloadGlb()'](src/react/hooks/useGlbAsset.ts:1)
- Ensure meshes set `castShadow` / `receiveShadow` as appropriate at load-time in code.
- Do not include lights/cameras in GLBs unless intentionally required.

## Performance Guidelines

- Keep polygon counts reasonable; use LODs for trees/foliage/props where helpful.
- Merge static meshes where feasible; keep draw calls low.
- Avoid excessive material slots; reuse materials and trimsheets.
- Prefer .glb over .fbx for runtime import. FBX can be retained as source but convert to GLB.

## Quality and Hygiene

- No secrets/metadata in binary assets.
- Remove orphan/unused assets from version control.
- Verify exports load correctly with Three.js GLTFLoader before committing.

## Checklist Before Commit

- [ ] Correct directory (characters/weapons/targets) under `assets/models/`
- [ ] GLB loads in a viewer and in the R3F scene
- [ ] Materials and textures resolving; power-of-two textures
- [ ] Reasonable scale and orientation (+Y up)
- [ ] Shadows configured appropriately in runtime code
- [ ] No unused nodes/animations/materials
